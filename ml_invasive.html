<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Wyclife Agumba Oluoch">
<meta name="dcterms.date" content="2024-11-19">

<title>Monitoring potential suitable habitat of invasive species</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="ml_invasive_files/libs/clipboard/clipboard.min.js"></script>
<script src="ml_invasive_files/libs/quarto-html/quarto.js"></script>
<script src="ml_invasive_files/libs/quarto-html/popper.min.js"></script>
<script src="ml_invasive_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ml_invasive_files/libs/quarto-html/anchor.min.js"></script>
<link href="ml_invasive_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ml_invasive_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ml_invasive_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ml_invasive_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ml_invasive_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><strong>Monitoring potential suitable habitat of invasive species</strong></h1>
<p class="subtitle lead"><strong>Machine Learning Tutorial</strong></p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Wyclife Agumba Oluoch </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 19, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>Invasive species are important factor for consideration in agriculture as they compromise crop performance and have the potential for compromising the native ecosystem and species composition of an area. It is estimated that the cost of damage caused by invasive species is 13 times higher than the cost of management <span class="citation" data-cites="diagne2021">(<a href="#ref-diagne2021" role="doc-biblioref">Diagne et al. 2021</a>)</span>. The same authors estimated the global cost of controlling invasive species as $1.3 trillion (2017 dollar rate). The control of invasive species also calls for use of herbicides in the cropland that are cost to crop production and could pose residual effects on the final products. By monitoring the current distribution of invasive species and predicting their potential future distribution, decision-makers can optimize strategies that can circumvent the spread of the species and improve agricultural productivity, all while ensuring sustainable land management practices.</p>
<p>In this post, we explore how to create species distribution maps of invasive weed species, <em>Parthenium hysterophorus</em> by integrating its occurrence records, bioclimate variables and <strong>R</strong> <span class="citation" data-cites="R.oo">(<a href="#ref-R.oo" role="doc-biblioref">Bengtsson 2003</a>)</span>for further processing and visualization. Using occurrence data from the <strong>GBIF</strong> <span class="citation" data-cites="gbif.org2020">(<a href="#ref-gbif.org2020" role="doc-biblioref">GBIF.org 2020</a>)</span> and climate data from <strong>WORLDCLIM</strong> <span class="citation" data-cites="fick2017">(<a href="#ref-fick2017" role="doc-biblioref">Fick and Hijmans 2017</a>)</span>, we focus on Uganda as a case study and demonstrate the workflow from data retrieval to final map creation. We chose Uganda since it is one of the countries which has substantial reported records of the invasive species.</p>
</section>
<section id="occurrence-records-global-biodiversity-information-facility-gbif" class="level2">
<h2 class="anchored" data-anchor-id="occurrence-records-global-biodiversity-information-facility-gbif"><strong>Occurrence records: Global Biodiversity Information Facility (GBIF)</strong></h2>
<p><a href="https://www.gbif.org/">GBIF</a> is a public database which contains a total of 3,024,406,282 as at 2024-11-19` occurrence records of species throughout the world. It is a great database for anyone interested in obtaining occurrence records of a species for modeling the potential suitable habitats since it has a lot of records with geospatial attributes. Other databases one can look into include <strong>eBird</strong>, <strong>RAINBIO</strong>, <strong>BIEN</strong>, herbarium, and ones own field surveys.</p>
<section id="loading-boundary-data-in-r" class="level3">
<h3 class="anchored" data-anchor-id="loading-boundary-data-in-r"><strong>1. Loading Boundary Data in R</strong></h3>
<p>We begin by loading the boundary data for Uganda using the <code>geodata</code>package <span class="citation" data-cites="geodata">(<a href="#ref-geodata" role="doc-biblioref">Hijmans et al. 2024</a>)</span>, which offers a convenient way to obtain a lot of geospatial data. There are several other options or packages one can use to get boundary data for their area of interest. We also include <code>terra</code> package <span class="citation" data-cites="terra">(<a href="#ref-terra" role="doc-biblioref">Hijmans 2024</a>)</span> to aid plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geodata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: terra</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>terra 1.7.83</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>uganda <span class="ot">&lt;-</span> <span class="fu">gadm</span>(<span class="at">country =</span> <span class="st">"Uganda"</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="dv">0</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">path =</span> <span class="fu">tempdir</span>(), </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">version =</span> <span class="st">"latest"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">resolution =</span> <span class="dv">1</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(uganda, <span class="at">border =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above code snippet loads Uganda’s administrative boundaries, with <code>level = 0</code> representing the national boundary and other levels like 1, 2 or 3 depict lower regional divisions.</p>
</section>
<section id="obtaining-occurrence-records-for-the-species-from-gbif" class="level3">
<h3 class="anchored" data-anchor-id="obtaining-occurrence-records-for-the-species-from-gbif"><strong>2. Obtaining occurrence records for the species from GBIF</strong></h3>
<p>In this next step we again use <code>geodata</code> package to obtain species occurrence records for the invasive species of interest to us.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>occ <span class="ot">&lt;-</span> <span class="fu">sp_occurrence</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">genus =</span> <span class="st">"Parthenium"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">species =</span> <span class="st">"hysterophorus"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ext =</span> uganda,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">removeZeros =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">geo =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">download =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ntries =</span> <span class="dv">5</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>222 records found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>0-222
222 records downloaded</code></pre>
</div>
</div>
</section>
<section id="cleaning-the-occurrence-records" class="level3">
<h3 class="anchored" data-anchor-id="cleaning-the-occurrence-records"><strong>3. Cleaning the occurrence records</strong></h3>
<p>Next, we use dplyr package to clean the data. In cleaning the data, we are interesting in:</p>
<ul>
<li><p>Retaining only the <strong>longitute</strong> and <strong>latitude</strong> columns.</p></li>
<li><p>Drop NAs</p></li>
<li><p>Removing duplicated locations.</p></li>
<li><p>Mutate a column for species with values of 1.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>occ_clean <span class="ot">&lt;-</span> occ <span class="sc">|&gt;</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(lon, lat) <span class="sc">|&gt;</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">drop_na</span>() <span class="sc">|&gt;</span> <span class="co"># Play around with drop_na before select</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species =</span> <span class="dv">1</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(occ_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       lon       lat species
1 34.74469 -0.117262       1
2 32.45997  0.063426       1
3 30.03423 -0.127958       1
4 34.03300 -0.491460       1
5 32.53238  0.413270       1
6 30.95265 -0.641107       1</code></pre>
</div>
</div>
<p>In other instances, one may be interested in checking also the year column so that only records observed within specific time periods are used for modeling. There are about 93 columns in the dataset and one may be interested in filtering for various reasons. For our demonstration here, we are satisfied with distinct records.</p>
</section>
<section id="make-the-occurrence-records-geospatial" class="level3">
<h3 class="anchored" data-anchor-id="make-the-occurrence-records-geospatial"><strong>4. Make the occurrence records geospatial</strong></h3>
<p>The next step is to make the occurrence records geospatial by using the <em>vect</em> function from <code>terra</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>occ_vect <span class="ot">&lt;-</span> occ_clean <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vect</span>(<span class="at">geom =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="st">"epsg:4326"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-the-records-in-uganda" class="level3">
<h3 class="anchored" data-anchor-id="visualize-the-records-in-uganda"><strong>5. Visualize the records in Uganda</strong></h3>
<p>To ensure the the records are located within Uganda as expected, we can overlay the plot of the records on the map of Uganda.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(uganda, <span class="at">border =</span> <span class="st">"blue"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(occ_vect, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>NOTE: When we provided the extent as Uganda, the <em>sp_occurrence</em> function used the bounding box of Uganda, not the actual border hence some of the points spill into Kenya. Therefore, we need to run a spatial analysis which drops all the points outside the border of Uganda. This is <em>crop</em> function from <code>terra</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>occ_ug <span class="ot">&lt;-</span> <span class="fu">crop</span>(occ_vect, uganda)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(uganda, <span class="at">border =</span> <span class="st">"blue"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(occ_ug, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="obtaining-predictor-variables" class="level3">
<h3 class="anchored" data-anchor-id="obtaining-predictor-variables"><strong>6. Obtaining predictor variables</strong></h3>
<p>In this next step, we are going to obtain predictor variables from worldclim. We will use <em>worldclim_country</em> function from <code>geodata</code> package which is super convenient.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> <span class="fu">worldclim_country</span>(<span class="at">country =</span> <span class="st">"Uganda"</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">var =</span> <span class="st">"bio"</span>, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">path =</span> <span class="fu">tempdir</span>(),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">version =</span> <span class="st">"2.1"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(predictors, <span class="st">"data/current.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-one-of-the-predictors" class="level3">
<h3 class="anchored" data-anchor-id="visualize-one-of-the-predictors"><strong>7. Visualize one of the predictors</strong></h3>
<p>We then confirm that the predictor variable covers our country of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/current.tif"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(predictors[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Just like with <em>sp_occurrence</em> which returned occurrence records based on the bounding box of Uganda instead of the country boundary, <em>worldclim_country</em> also returned the predictor variables based on the bounding box of Uganda. This means we need to run another code to clip the predictors to the boundaries of Uganda only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>preds_ug <span class="ot">&lt;-</span> <span class="fu">crop</span>(predictors, uganda, <span class="at">mask =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Confirm that the shape of the predictor variables is now perfect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(preds_ug[[<span class="dv">1</span>]])</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(uganda, <span class="at">border =</span> <span class="st">"blue"</span>, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can also confirm that the occurrence records are overlaying the predictor variables perfectly. Sometimes one may get occurrence records, study area boundaries and predictor variables that are on different coordinate reference systems.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(preds_ug[[<span class="dv">1</span>]])</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(uganda, <span class="at">border =</span> <span class="st">"blue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(occ_ug, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="check-and-drop-highly-correlated-variables" class="level3">
<h3 class="anchored" data-anchor-id="check-and-drop-highly-correlated-variables"><strong>8. Check and drop highly correlated variables</strong></h3>
<p>It is always important to drop all variables that are highly correlated from the modeling workflow. This we can do for the whole of the study area or specific to the occurrence points. Either way is acceptable. For that, we will use <code>usdm</code> <span class="citation" data-cites="usdm">(<a href="#ref-usdm" role="doc-biblioref">Naimi et al. 2014</a>)</span> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(usdm)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>correlated <span class="ot">&lt;-</span> <span class="fu">vifcor</span>(preds_ug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Excluding the highly correlated variables in order to remain with those that are valuable in predicting the potential suitable habitat for the species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>preds_ug_used <span class="ot">&lt;-</span> <span class="fu">exclude</span>(preds_ug, correlated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us rename the predictor layers to have concise names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(preds_ug_used)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "wc2.1_30s_bio_2"  "wc2.1_30s_bio_4"  "wc2.1_30s_bio_8"  "wc2.1_30s_bio_9" 
[5] "wc2.1_30s_bio_13" "wc2.1_30s_bio_14" "wc2.1_30s_bio_15" "wc2.1_30s_bio_18"
[9] "wc2.1_30s_bio_19"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(preds_ug_used) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"bio"</span>, <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">18</span>,<span class="dv">19</span>))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(preds_ug_used)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bio2"  "bio4"  "bio8"  "bio9"  "bio13" "bio14" "bio15" "bio18" "bio19"</code></pre>
</div>
</div>
</section>
<section id="build-the-sdmdata-object-and-model" class="level3">
<h3 class="anchored" data-anchor-id="build-the-sdmdata-object-and-model"><strong>9. Build the sdmData object and model</strong></h3>
<p>In this next step, we will build the machine learning model which will be able to take the current occurrence points and predictor variables to calibrate a model that can predict where else the species could occur. For that, we will use <code>sdm</code> package <span class="citation" data-cites="sdm">(<a href="#ref-sdm" role="doc-biblioref">Naimi and Araujo 2016</a>)</span>. There are several other packages that can achieve this, such as <code>ENMeval</code> <span class="citation" data-cites="ENMeval">(<a href="#ref-ENMeval" role="doc-biblioref">Kass et al. 2021</a>)</span>, <code>wallace</code> <span class="citation" data-cites="wallace">(<a href="#ref-wallace" role="doc-biblioref"> et al. 2023</a>)</span>, <code>ENMTools</code> <span class="citation" data-cites="ENMTools">(<a href="#ref-ENMTools" role="doc-biblioref">Warren and Dinnage 2024</a>)</span>, <code>biomod2</code> <span class="citation" data-cites="biomod2">(<a href="#ref-biomod2" role="doc-biblioref">Thuiller et al. 2024</a>)</span>, <code>dismo</code> <span class="citation" data-cites="dismo">(<a href="#ref-dismo" role="doc-biblioref">Hijmans et al. 2023</a>)</span> among others.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sdm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>sdm 1.2-46 (2024-07-17)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>sdm_data <span class="ot">&lt;-</span> <span class="fu">sdmData</span>(<span class="at">formula =</span> species <span class="sc">~</span>., </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">train =</span> occ_ug, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">predictors =</span> preds_ug_used, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">bg =</span> <span class="fu">list</span>(<span class="at">method =</span> <span class="st">"gRandom"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n =</span> <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Have a glance at the sdm_data object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sdm_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class                                 : sdmdata 
=========================================================== 
number of species                     :  1 
species names                         :  species 
number of features                    :  9 
feature names                         :  bio2, bio4, bio8, ... 
type                                  :  Presence-Background 
has independet test data?             :  FALSE 
number of records                     :  1064 
has Coordinates?                      :  TRUE </code></pre>
</div>
</div>
<p>Then the model calibration:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sdm_model <span class="ot">&lt;-</span> <span class="fu">sdm</span>(<span class="at">formula =</span> species <span class="sc">~</span>.,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> sdm_data, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">methods =</span> <span class="st">"maxent"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">replications =</span> <span class="st">"boot"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">test.p =</span> <span class="dv">30</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write.sdm</span>(sdm_model, <span class="st">"model/sdm_model.sdm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>View the model summary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>sdm_model <span class="ot">&lt;-</span> <span class="fu">read.sdm</span>(<span class="st">"model/sdm_model.sdm"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>sdm_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class                                 : sdmModels 
======================================================== 
number of species                     :  1 
number of modelling methods           :  1 
names of modelling methods            :  maxent 
replicate.methods (data partitioning) :  bootstrap 
number of replicates (each method)    :  3 
toral number of replicates per model  :  3 (per species) 
------------------------------------------
model run success percentage (per species)  :
------------------------------------------
method          species          
---------------------- 
maxent     :        100   %

###################################################################
model Mean performance (per species), using test dataset (generated using partitioning):
-------------------------------------------------------------------------------

 ## species   :  species 
=========================

methods    :     AUC     |     COR     |     TSS     |     Deviance 
-------------------------------------------------------------------------
maxent     :     0.81    |     0.31    |     0.52    |     1.04     </code></pre>
</div>
</div>
<p>Other checks on the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rcurve</span>(sdm_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'ggplot2'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:kernlab':

    alpha</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:randomForest':

    margin</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>The id argument is not specified; The modelIDs of 3 successfully fitted models are assigned to id...! </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc</span>(sdm_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">getVarImp</span>(sdm_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
The variable importance for all the models are combined (averaged)... </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="note" class="level3">
<h3 class="anchored" data-anchor-id="note"><strong>10. NOTE</strong></h3>
<p>One can redo what we have done up to here several times, tuning the modelling process until a model with desirable characteristics is attained. Basically, this is a model that meets the specific needs of the project. For example, one can change the number of replications (20 etc), replication methods (sub, cv), model methods (brt, gam, glm, rf, svm). One can also add occurrence records (e.g.&nbsp;from BIEN), one can also add predictor variables (soil, elevation…but be careful with remote sensing data as they are object specific and less of environment).</p>
</section>
<section id="predict-the-potential-suitable-habitat-for-the-species" class="level3">
<h3 class="anchored" data-anchor-id="predict-the-potential-suitable-habitat-for-the-species"><strong>11. Predict the potential suitable habitat for the species</strong></h3>
<p>Finally, we get to the point where we use the trained model to predict the potential suitable habitat of the species over the study area. For this, we use <em>predict</em> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> sdm_model, preds_ug_used)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 686, 651, 3  (nrow, ncol, nlyr)
resolution  : 0.008333333, 0.008333333  (x, y)
extent      : 29.575, 35, -1.483333, 4.233333  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source(s)   : memory
names       : id_1__sp_s~t__re_boot, id_2__sp_s~t__re_boot, id_3__sp_s~t__re_boot 
min values  :           0.002192378,           0.005477519,           0.005691341 
max values  :           1.000000000,           0.999999702,           0.999999762 </code></pre>
</div>
</div>
<p>This is giving us three layers of <code>spatRaster</code> corresponding to the three runs.</p>
<p>We can visualize them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Normally, we take the median of the predictions since we only have one method ‘maxent’. When more than one method, we may be careful to only get median of each method separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>pred_median <span class="ot">&lt;-</span> <span class="fu">median</span>(pred)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also visualize the map of the occurrence points on top of this prediction so that we visually inspect how well the model performed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_median)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(uganda, <span class="at">border =</span> <span class="st">"blue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(occ_ug, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="binarize-the-suitability-map-for-presence-absence-map" class="level3">
<h3 class="anchored" data-anchor-id="binarize-the-suitability-map-for-presence-absence-map"><strong>12. Binarize the suitability map for presence absence map</strong></h3>
<p>We now need to make an important step which is to binarize the map into presence-absence map. This is a map which we can therefore use to tell how much land is under the weed. However, since we actually have not been in the field to make the observation of the fields, we use threshold based evaluation metrics to create a cut-off point along the 0 to 1 suitability scale. To get the evaluation metrics, we are going to compare the true presences and the background points with the predicted values on the map. This involves the following steps:</p>
<p>i. Getting the observed records and their locations (x, y, species)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>obs_coords <span class="ot">&lt;-</span> <span class="fu">coords</span>(sdm_data) <span class="co"># Get all coordinates</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>obs_species <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sdm_data) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species) <span class="co"># Get species; 1 or 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ii. Getting predicted values at the observed locations. Not so good with presence-background data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pred_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(pred_median, obs_coords)<span class="sc">$</span>median</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use the two (observed values and predicted values) to run evaluation of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>eva <span class="ot">&lt;-</span> <span class="fu">evaluates</span>(<span class="at">x =</span> obs_species<span class="sc">$</span>species, <span class="at">p =</span> pred_values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are up to 15 threshold-based evaluation metrics which one can pick from. For this case we will go by the one which maximizes sensitivity and specificity. We will call it th for threshold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>th <span class="ot">&lt;-</span> eva<span class="sc">@</span>threshold_based[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>th</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.45066</code></pre>
</div>
</div>
<p>Now, with this threshold we can predict the potential presence points for the species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>pa <span class="ot">&lt;-</span> pred_median</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>pa[] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pa[] <span class="sc">&gt;=</span> th, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="predictions-into-the-future" class="level3">
<h3 class="anchored" data-anchor-id="predictions-into-the-future"><strong>13. Predictions into the future</strong></h3>
<p>Since we have built our model, we can use it to make predictions across space and time. For instance, we can use the model to make prediction in another country, say Kenya, in case we currently did not have occurrence records in Kenya to train the model on. We can also use the same model to make predictions into the future.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fut_pred <span class="ot">&lt;-</span> <span class="fu">cmip6_tile</span>(<span class="at">lon =</span> <span class="dv">32</span>, </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="dv">1</span>, </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> <span class="st">"HadGEM3-GC31-LL"</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ssp =</span> <span class="st">"245"</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">time =</span> <span class="st">"2041-2060"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var =</span> <span class="st">"bioc"</span>, </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">path =</span> <span class="fu">tempdir</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us visualize one layer from the downloaded tile.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fut_pred[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Seems the tile does not cover the whole of our study area of interest as it covers only above the equator. Now we need additional three tiles in order to cover the whole of Uganda.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tile_ne <span class="ot">&lt;-</span> <span class="fu">cmip6_tile</span>(<span class="at">lon =</span> <span class="dv">32</span>, </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="dv">1</span>, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> <span class="st">"HadGEM3-GC31-LL"</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ssp =</span> <span class="st">"245"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">time =</span> <span class="st">"2041-2060"</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var =</span> <span class="st">"bioc"</span>, </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">path =</span> <span class="fu">tempdir</span>())</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>tile_se <span class="ot">&lt;-</span> <span class="fu">cmip6_tile</span>(<span class="at">lon =</span> <span class="dv">32</span>, </span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> <span class="st">"HadGEM3-GC31-LL"</span>,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ssp =</span> <span class="st">"245"</span>,</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">time =</span> <span class="st">"2041-2060"</span>,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var =</span> <span class="st">"bioc"</span>, </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">path =</span> <span class="fu">tempdir</span>())</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>tile_sw <span class="ot">&lt;-</span> <span class="fu">cmip6_tile</span>(<span class="at">lon =</span> <span class="dv">28</span>, </span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> <span class="st">"HadGEM3-GC31-LL"</span>,</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ssp =</span> <span class="st">"245"</span>,</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">time =</span> <span class="st">"2041-2060"</span>,</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var =</span> <span class="st">"bioc"</span>, </span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">path =</span> <span class="fu">tempdir</span>())</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>tile_nw <span class="ot">&lt;-</span> <span class="fu">cmip6_tile</span>(<span class="at">lon =</span> <span class="dv">28</span>, </span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="dv">1</span>, </span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> <span class="st">"HadGEM3-GC31-LL"</span>,</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ssp =</span> <span class="st">"245"</span>,</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">time =</span> <span class="st">"2041-2060"</span>,</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var =</span> <span class="st">"bioc"</span>, </span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">path =</span> <span class="fu">tempdir</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merging all the tiles:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we subset only the layers we used for training the model</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>sub_index <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">13</span><span class="sc">:</span><span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span><span class="sc">:</span><span class="dv">19</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>tile_ne_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(tile_ne, sub_index)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>tile_se_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(tile_se, sub_index)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>tile_sw_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(tile_sw, sub_index)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>tile_nw_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(tile_nw, sub_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now merge them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>merged_fut <span class="ot">&lt;-</span> <span class="fu">merge</span>(tile_ne_sub, tile_se_sub, tile_sw_sub, tile_nw_sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualize the one of the layers in the merged _fut:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(merged_fut[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can crop it to the extent of Uganda and visualize.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>merged_fut_cropped <span class="ot">&lt;-</span> <span class="fu">crop</span>(merged_fut, uganda, <span class="at">mask =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(merged_fut_cropped[[<span class="dv">1</span>]])</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(merged_fut_cropped, <span class="st">"data/future.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>merged_fut_cropped <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/future.tif"</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(merged_fut_cropped[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can use out trained model to predict the potential suitable habitat for the species by the year 2041-2060 under shared socio-economic pathway 2.45 and using the <strong>HadGEM3-GC31-LL</strong> Global Circulation Model. But first we need to assign the same names to this future layers as that of the current layers where the model was trained.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(merged_fut_cropped) <span class="ot">&lt;-</span> <span class="fu">names</span>(preds_ug_used)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can go ahead with the prediction step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fut_pred <span class="ot">&lt;-</span> <span class="fu">median</span>(<span class="fu">predict</span>(<span class="at">object =</span> sdm_model, </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">newdata =</span> merged_fut_cropped))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualize the future habitat suitability map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fut_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Using the same threshold we can create a binary map for the future.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fut_pa <span class="ot">&lt;-</span> fut_pred</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>fut_pa[] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(fut_pa[] <span class="sc">&gt;=</span> th, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fut_pa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can look at both maps side by side:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pa, <span class="at">main =</span> <span class="st">"Current"</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fut_pa, <span class="at">main =</span> <span class="st">"Future"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can do a little logical operation to see which areas will experience expansion, contraction, persistence and absence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>change <span class="ot">&lt;-</span> pa <span class="co"># ch for change</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>change[] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pa[] <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> fut_pa[] <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">ifelse</span>(pa[] <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> fut_pa[] <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(pa[] <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> fut_pa[] <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot the change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(change)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Better map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>ch_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(change, <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ch_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> <span class="fu">as.factor</span>(median))) <span class="sc">+</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"gray"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"2"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"3"</span> <span class="ot">=</span> <span class="st">"green"</span>),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Absence"</span>, <span class="st">"Expansion"</span>, <span class="st">"Contraction"</span>, <span class="st">"Persistance"</span>),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Legend"</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Change plot"</span>,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Longitude"</span>,</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Latitude"</span>) <span class="sc">+</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To know the area under each class we can use zonal statistics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>zonal_areas <span class="ot">&lt;-</span> <span class="fu">zonal</span>(<span class="fu">cellSize</span>(change, <span class="at">unit =</span> <span class="st">"km"</span>), change, <span class="at">fun =</span> <span class="st">"sum"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>zonal_areas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  median       area
1      0 138039.598
2      1  34698.112
3      2   9783.595
4      3  60355.999</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>zonal_areas <span class="sc">|&gt;</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">c</span>(<span class="st">"Absence"</span>, <span class="st">"Expansion"</span>, <span class="st">"Contraction"</span>, <span class="st">"Persistence"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> class, <span class="at">y =</span> area), <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"gray"</span>, <span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"green"</span>)) <span class="sc">+</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Change class"</span>, <span class="at">y =</span> <span class="st">"Class area (km²)"</span>) <span class="sc">+</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cropland-overlay" class="level3">
<h3 class="anchored" data-anchor-id="cropland-overlay"><strong>14. Cropland overlay</strong></h3>
<p>Lastly, we can find out how much of the Ugandan cropland will be affected by the species in future. For that we will need the cropland map of Uganda. We can obtain cropland data from using cropland function in geodata package. Specifically, we use the WorldCover <span class="citation" data-cites="zanaga2021">(<a href="#ref-zanaga2021" role="doc-biblioref">Zanaga et al. 2021</a>)</span> fractional cropland data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>cropland_ug <span class="ot">&lt;-</span> <span class="fu">cropland</span>(<span class="at">source =</span> <span class="st">"WorldCover"</span>, <span class="at">path =</span> <span class="st">"data/cropland_ug.tif"</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>cropland_ug_ <span class="ot">&lt;-</span> <span class="fu">crop</span>(cropland_ug, uganda, <span class="at">mask =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(cropland_ug_, <span class="st">"data/cropland_ug_cropped.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>ug_cropland <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/cropland_ug_cropped.tif"</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ug_cropland)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The pixel values represent the fraction of cropland in each cell. Let us assume that where the fraction is above 0.25 is considered cropland. The aim is to have a binary map of cropland or no cropland.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>crop_bin <span class="ot">&lt;-</span> ug_cropland</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>crop_bin[] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(crop_bin[] <span class="sc">&gt;=</span> <span class="fl">0.25</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(crop_bin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can determine how much of the current cropland is affected by the weed and also we can predict how much of the future land may likely be affected by the invasive species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>current_affected <span class="ot">&lt;-</span> pa</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>future_affected <span class="ot">&lt;-</span> pa</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>current_affected[] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pa[] <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> crop_bin[] <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>future_affected[] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(fut_pa[] <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> crop_bin[] <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualize them</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(current_affected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(future_affected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>curr_affected_area <span class="ot">&lt;-</span> <span class="fu">zonal</span>(<span class="fu">cellSize</span>(current_affected, <span class="at">unit =</span> <span class="st">"km"</span>), current_affected, <span class="at">fun =</span> <span class="st">"sum"</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>fut_affected_area <span class="ot">&lt;-</span> <span class="fu">zonal</span>(<span class="fu">cellSize</span>(future_affected, <span class="at">unit =</span> <span class="st">"km"</span>), future_affected, <span class="at">fun =</span> <span class="st">"sum"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>df_affected <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Current"</span>, <span class="st">"Future"</span>),</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> <span class="fu">c</span>(curr_affected_area<span class="sc">$</span>area[<span class="dv">2</span>], fut_affected_area<span class="sc">$</span>area[<span class="dv">2</span>]))</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>df_affected <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Area km²"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ml_invasive_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion-key-observations-from-the-parthenium-hyterophorus" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-key-observations-from-the-parthenium-hyterophorus"><strong>Conclusion: Key Observations from the <em>Parthenium hyterophorus</em></strong></h3>
<p>The map of potential suitable habitat of <em>Parthenium hysterophorus</em> suggest expansion with climate change. In the <strong>Cental and Southwestern regions</strong> the species is likely to pose more harm to farmers as it characterizes highly suitable environment for the species. Even though northern Uganda is currently less suitable for the species, the model predicts rapid expansion in habitat suitability for the species in the region into the 2041 - 2060 period. Using the cropland map from WorldCover, we predict that the invasive species is set to pose more havoc for croplands in Uganda in the future.</p>
<p><strong>Feel free to reach me out if you got any questions.</strong></p>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-R.oo" class="csl-entry" role="listitem">
Bengtsson, Henrik. 2003. <span>“The <span></span>r.oo<span></span> Package - Object-Oriented Programming with References Using Standard <span></span>r<span></span> Code.”</span> <em>Proceedings of the 3rd International Workshop on Distributed Statistical Computing (DSC 2003)</em>. <a href="https://www.r-project.org/conferences/DSC-2003/Proceedings/Bengtsson.pdf">https://www.r-project.org/conferences/DSC-2003/Proceedings/Bengtsson.pdf</a>.
</div>
<div id="ref-diagne2021" class="csl-entry" role="listitem">
Diagne, Christophe, Boris Leroy, Anne-Charlotte Vaissière, Rodolphe E. Gozlan, David Roiz, Ivan Jarić, Jean-Michel Salles, Corey J. A. Bradshaw, and Franck Courchamp. 2021. <span>“High and Rising Economic Costs of Biological Invasions Worldwide.”</span> <em>Nature</em> 592 (7855): 571–76. <a href="https://doi.org/10.1038/s41586-021-03405-6">https://doi.org/10.1038/s41586-021-03405-6</a>.
</div>
<div id="ref-fick2017" class="csl-entry" role="listitem">
Fick, Stephen E., and Robert J. Hijmans. 2017. <span>“WorldClim 2: New 1-Km Spatial Resolution Climate Surfaces for Global Land Areas.”</span> <em>International Journal of Climatology</em>. <a href="https://doi.org/10.1002/joc.5086">https://doi.org/10.1002/joc.5086</a>.
</div>
<div id="ref-gbif.org2020" class="csl-entry" role="listitem">
GBIF.org. 2020. <span>“GBIF Home Page.”</span> <a href="https://www.gbif.org">https://www.gbif.org</a>.
</div>
<div id="ref-terra" class="csl-entry" role="listitem">
Hijmans, Robert J. 2024. <span>“Terra: Spatial Data Analysis.”</span> <a href="https://CRAN.R-project.org/package=terra">https://CRAN.R-project.org/package=terra</a>.
</div>
<div id="ref-geodata" class="csl-entry" role="listitem">
Hijmans, Robert J., Márcia Barbosa, Aniruddha Ghosh, and Alex Mandel. 2024. <span>“Geodata: Download Geographic Data.”</span> <a href="https://CRAN.R-project.org/package=geodata">https://CRAN.R-project.org/package=geodata</a>.
</div>
<div id="ref-dismo" class="csl-entry" role="listitem">
Hijmans, Robert J., Steven Phillips, John Leathwick, and Jane Elith. 2023. <span>“Dismo: Species Distribution Modeling.”</span> <a href="https://CRAN.R-project.org/package=dismo">https://CRAN.R-project.org/package=dismo</a>.
</div>
<div id="ref-wallace" class="csl-entry" role="listitem">
J. M. Kass, G. E. Pinilla-Buitrago, A. Paz, B. A. Johnson, V. Grisales-Betancur, S. I. Meenan, D. Attali, et al. 2023. <span>“Wallace 2: A Shiny App for Modeling Species Niches and Distributions Redesigned to Facilitate Expansion via Module Contributions”</span> 2023(3): 1–9. <a href="https://onlinelibrary.wiley.com/doi/10.1111/ecog.06547">https://onlinelibrary.wiley.com/doi/10.1111/ecog.06547</a>.
</div>
<div id="ref-ENMeval" class="csl-entry" role="listitem">
Kass, J. M., R. Muscarella, P. J. Galante, C. L. Bohl, G. E. Pinilla-Buitrago, R. A. Boria, M. Soley-Guardia, and R. P. Anderson. 2021. <span>“ENMeval 2.0: Redesigned for Customizable and Reproducible Modeling of Species<span>’</span> Niches and Distributions”</span> 12: 1602–8. <a href="https://doi.org/10.1111/2041-210X.13628">https://doi.org/10.1111/2041-210X.13628</a>.
</div>
<div id="ref-sdm" class="csl-entry" role="listitem">
Naimi, Babak, and Miguel B. Araujo. 2016. <span>“Sdm: A Reproducible and Extensible r Platform for Species Distribution Modelling”</span> 39: 368–75. <a href="https://doi.org/10.1111/ecog.01881">https://doi.org/10.1111/ecog.01881</a>.
</div>
<div id="ref-usdm" class="csl-entry" role="listitem">
Naimi, Babak, Nicholas a.s. Hamm, Thomas A. Groen, Andrew K. Skidmore, and Albertus G. Toxopeus. 2014. <span>“Where Is Positional Uncertainty a Problem for Species Distribution Modelling”</span> 37: 191–203. <a href="https://doi.org/10.1111/j.1600-0587.2013.00205.x">https://doi.org/10.1111/j.1600-0587.2013.00205.x</a>.
</div>
<div id="ref-biomod2" class="csl-entry" role="listitem">
Thuiller, Wilfried, Damien Georges, Maya Gueguen, Robin Engler, Frank Breiner, Bruno Lafourcade, Remi Patin, and Helene Blancheteau. 2024. <span>“Biomod2: Ensemble Platform for Species Distribution Modeling.”</span> <a href="https://CRAN.R-project.org/package=biomod2">https://CRAN.R-project.org/package=biomod2</a>.
</div>
<div id="ref-ENMTools" class="csl-entry" role="listitem">
Warren, Dan, and Russell Dinnage. 2024. <span>“ENMTools: Analysis of Niche Evolution Using Niche and Distribution Models.”</span> <a href="https://CRAN.R-project.org/package=ENMTools">https://CRAN.R-project.org/package=ENMTools</a>.
</div>
<div id="ref-zanaga2021" class="csl-entry" role="listitem">
Zanaga, Daniele, Ruben Van De Kerchove, Wanda De Keersmaecker, Niels Souverijns, Carsten Brockmann, Ralf Quast, Jan Wevers, et al. 2021. <span>“ESA WorldCover 10 m 2020 V100.”</span> Zenodo. <a href="https://doi.org/10.5281/ZENODO.5571936">https://doi.org/10.5281/ZENODO.5571936</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>